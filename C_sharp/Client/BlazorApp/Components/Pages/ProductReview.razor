@page "/reseller/product/{ProductId:int}"
@using ApiContracts.Dtos
@rendermode InteractiveServer
@inject BlazorApp.Services.Interface.IProductInspectionService inspectionService
@inject NavigationManager Nav
<h3>Review Product</h3>

@if (loading)
{
    <p><em>Loading product...</em></p>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger">@error</div>
}
else if (product is null)
{
    <p>Product not found.</p>
}
else
{
    <div class="card mb-3">
        <div class="row g-0">
            <div class="col-md-4">
                 @if (product.Images != null && product.Images.Any())
                {
                    @foreach (var img in product.Images)
                    {
                        <img class="img-fluid rounded-start mb-2"
                             src="@img.Url"
                             alt="@product.Name" />
                    }
                }
            </div>
            <div class="col-md-8">
                <div class="card-body">
                    <h5 class="card-title">@product.Name (@product.Price.ToString("0.00") DKK)</h5>
                    <p class="card-text">
                        <strong>Condition:</strong> @product.Condition<br />
                        <strong>Category:</strong> @product.Category<br />
                        <strong>Description:</strong> @product.Description<br />
                        <strong>Current status:</strong> @product.ApprovalStatus
                    </p>

                    <h6>Seller</h6>
                    <p class="card-text">
                        @product.SellerFirstName @product.SellerLastName<br />
                        @product.SellerEmail<br />
                        @product.SellerPhoneNumber
                    </p>

                    <h6>Pawnshop</h6>
                    <p class="card-text">
                        @product.PawnshopName<br />
                        @product.PawnshopStreetName @product.PawnshopSecondaryUnit<br />
                        @product.PawnshopPostalCode @product.PawnshopCity
                    </p>
                </div>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success">@successMessage</div>
    }

    <EditForm Model="form" OnValidSubmit="SubmitReview">
        <DataAnnotationsValidator />
        <ValidationSummary />

      <div class="mb-3 form-check">
    <InputCheckbox class="form-check-input" @bind-Value="form.IsAccepted" />
        <label class="form-check-label">
            @(
               product?.ApprovalStatus?.Equals("reviewing", StringComparison.OrdinalIgnoreCase) == true
               ? "Accept this product for selling"
               : "Confirm this product for reviewing in the pawnshop"
             )
        </label>
</div>

        <div class="mb-3">
            <label class="form-label">Pawnshop Id</label>
            <InputNumber class="form-control" @bind-Value="form.PawnshopId" />
        </div>

        <div class="mb-3">
            <label class="form-label">Comments</label>
            <InputTextArea class="form-control" @bind-Value="form.Comments" />
        </div>

    <button class="btn btn-primary" type="button"
        disabled="@(busy || cooldownActive)"
        @onclick="HandleActionWithCooldown">
        @(busy
            ? (IsReviewing ? "Verifying..." : "Submitting...")
            : (IsReviewing ? "Verify Product" : "Submit Review"))
    </button>
        <button class="btn btn-secondary ms-2" type="button"
                @onclick="@(() => Nav.NavigateTo("/reseller/pending-products"))">
            Back to list
        </button>
        </EditForm>
@code {
    [Parameter] public int ProductId { get; set; }

    private DetailedProductDto? product;
    private ProductInspectionDto form = new(); 
	private ProductVerificationDto verificationForm = new();
    private bool loading = true;
    private bool busy;
    private bool cooldownActive = false;
    private string? error;
    private string? successMessage;
	private bool IsReviewing => product?.ApprovalStatus?
                    .Equals("reviewing", StringComparison.OrdinalIgnoreCase) == true;

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            loading = true;
            error = null;
            successMessage = null;

            product = await inspectionService.GetProductDetailsAsync(ProductId);

            
            form = new ProductInspectionDto
            {
                ResellerId = 1,     // TODO: derive from logged-in reseller
                PawnshopId = product.PawnshopId,
                Comments = "",
                IsAccepted = true
            };
            verificationForm = new ProductVerificationDto
            {
                ResellerId = 1,     // TODO: derive from logged-in verifier
                Comments = "",
                IsAccepted = true
			};
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    private async Task HandleActionAsync()
    {
        if (IsReviewing)
        {
            await VerifyProduct();
        }
        else
        {
            await SubmitReview();
        }
    }

    private async Task HandleActionWithCooldown()
    {
        await HandleActionAsync();

        cooldownActive = true;
        StateHasChanged();
        await Task.Delay(5000); // 5 sec
        cooldownActive = false;
        StateHasChanged();
    }

    private async Task SubmitReview()
    {
        busy = true;
        error = null;
        successMessage = null;

        try
        {
            var result = await inspectionService.ReviewProductAsync(ProductId, form);

            successMessage =
                $"Review saved. ProductId={result.ProductId}, New status={result.ApprovalStatus}, PawnshopId={result.PawnshopId}";
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            busy = false;
        }
    }

    private async Task VerifyProduct()
    {
        busy = true;
        error = null;
        successMessage = null;

        try
        {
            var result = await inspectionService.VerifyProductAsync(ProductId, verificationForm);

            successMessage =
                $"Product Verified. ProductId={result.ProductId}, New status={result.ApprovalStatus}";
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            busy = false;
        }
    }

    // Try common property names at runtime so the Razor compiles even if the DTO uses a different name (PhotoUrl, images, Images, etc.)
    @* private string? GetProductImage(DetailedProductDto? p)
    {
        if (p == null) return null;

        var type = p.GetType();
        string[] names = new[] { "PhotoUrl", "Photo", "Images", "images", "ImageUrl", "Image", "PhotoUrls" };

        foreach (var name in names)
        {
            var prop = type.GetProperty(name);
            if (prop != null)
            {
                var val = prop.GetValue(p) as string;
                if (!string.IsNullOrWhiteSpace(val)) return val;
            }
        }

        return null;
    }
}           busy = false;
        } *@
    }
}
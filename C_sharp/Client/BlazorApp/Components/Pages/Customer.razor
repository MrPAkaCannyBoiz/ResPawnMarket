@page "/customer/info"
@using ApiContracts
@using ApiContracts.Dtos
@using BlazorApp.Services.Interface
@attribute [Authorize(Roles = "Customer")]
@inject AuthenticationStateProvider AuthStateProvider
@inject IGetCustomerService GetCustomerService
@inject NavigationManager Nav

<link href="css/Customer.css" rel="stylesheet" />
<div class="profile-page">
    <div class="profile-card">

        <h2 class="profile-title">Customer Profile</h2>

@if (_loading)
{
    <p>loading...</p>
}
else if (_error is not null)
{
    <div class="alert alert-danger">@_error</div>
}
else if (_customer is null)
{
    <div class="alert alert-warning">Not found.</div>
}
else
{
<div class="profile-grid">
    <div class="label">Id</div>
    <div class="value">@_customer.Id</div>

    <div class="label">FirstName</div>
    <div class="value">@_customer.FirstName</div>
    
    <div class="label">LastName</div>
    <div class="value">@_customer.LastName</div>


    <div class="label">Email</div>
    <div class="value">@_customer.Email</div>

    <div class="label">Phone</div>
    <div class="value">@_customer.PhoneNumber</div>

    <div class="label">Address</div>
        <div class="value">@_customer.StreetName, @_customer.SecondaryUnit<br/>@_customer.PostalCode @_customer.City</div>
        
</div>
	 <button class="update-btn"  @onclick="NavigateToUpdateCustomer">Go To Update Customer</button>
}
    </div>
</div>

@code {
    private int id { get; set; }
    private CustomerDto? _customer;
    private string? _error;
    private bool _loading = true;


    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        _error = null;
        _customer = null;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? false)
        {
            Nav.NavigateTo("/customer-login", forceLoad: true);
            return;
        }
        // Read the ID claim from the token
        var idClaim = user.FindFirst("CustomerId")?.Value;
        if (string.IsNullOrWhiteSpace(idClaim) || !int.TryParse(idClaim, out var customerIdFromToken))
        {
            Nav.NavigateTo("/customer-login", forceLoad: true);
            return;
        }
        id = customerIdFromToken;

        try
        {
            _customer = await GetCustomerService.GetCustomerByIdAsync(id);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private void NavigateToUpdateCustomer()
    {
        Nav.NavigateTo($"/customer/info/update");
	}
}

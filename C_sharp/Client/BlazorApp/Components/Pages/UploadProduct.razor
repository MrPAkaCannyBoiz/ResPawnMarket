@page "/customer/new-product"
@*TODO: Remove the user id input, and replace it with proper login system*@
@using ApiContracts.Dtos
@using ApiContracts.Dtos.Enums
@using BlazorApp.Services.Interface
@using System.Security.Claims
@attribute [Authorize(Roles = "Customer")]
@attribute [Authorize(Policy = "CanSellProduct")]
@rendermode InteractiveServer
@inject IUploadProductService UploadProductService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav


@code 
{
	// attributes for UploadProductDto
	private double _price ;
	private string? _condition ;
	private string? _description ;
	private string? _name ;
	private string? _photoUrl0;
	private string? _photoUrl1;
	private string? _photoUrl2;
	private string? _photoUrl3;
	private string? _photoUrl4;
	private Category _category ;
	private string _otherCategory = "";
	private UploadProductDto? _uploadProductDto; 
	// down below is for binding/blazor purposes
	private int _userIdToUpload;
	private string? _uploadProductMessage;
	private bool _ispriceValid => _price >= 0;
	private bool _isStringValid(string? str) => !string.IsNullOrWhiteSpace(str);
	private bool _isBusy;

	protected override async Task OnInitializedAsync()
	{
		var authState = await AuthStateProvider.GetAuthenticationStateAsync();
		var user = authState.User;
		// If not authenticated, redirect to login
		if (!user.Identity?.IsAuthenticated ?? false)
		{
			Nav.NavigateTo("/customer-login", forceLoad: true);
			return;
		}
		// Read the ID claim from the token
		var idClaim = user.FindFirst("CustomerId")?.Value
					  ?? user.FindFirst("sub")?.Value; // fallback if you used "sub"
		if (string.IsNullOrWhiteSpace(idClaim) || !int.TryParse(idClaim, out var userIdFromToken))
		{
			Nav.NavigateTo("/customer-login", forceLoad: true);
			return;
		}
		_userIdToUpload = userIdFromToken;
	}

	private async Task UploadNewProduct()
	{
		_uploadProductMessage = null;
		_isBusy = true;
		try
		{
			if (!(_isStringValid(_name)
				&& _isStringValid(_description)
				&& _isStringValid(_condition)
				&& _ispriceValid
				&& IsFirstUrlFilled()
				&& (_category != Category.OTHER || _isStringValid(_otherCategory))))		
			{
				_uploadProductMessage = "Please correct the input before uploading. Some fields are missing or invalid.";
				return;
			}
			_uploadProductDto = new()
			{
				Price = _price,
				Condition = _condition!,
				Description = _description!,
				Name = _name!,
				Category = _category,
				OtherCategory = _otherCategory,
				ImageUrls = new List<string>()
				{
					_photoUrl0!,
					_photoUrl1!,
					_photoUrl2!,
					_photoUrl3!,
					_photoUrl4!
				}.Where(url => IsValidPhotoUrl(url)).ToList()
			};
			var result = await UploadProductService
							.UploadProductAsync(_userIdToUpload, _uploadProductDto);
			_uploadProductMessage = "Item uploaded successfully! (Admin will soon check it)";

			// Clear form
			            _price = 0;
            _condition = "";
            _description = "";
            _name = "";
            _photoUrl0 = "";
            _photoUrl1 = "";
            _photoUrl2 = "";
            _photoUrl3 = "";
            _photoUrl4 = "";
            _category = Category.CATEGORY_UNSPECIFIED;
            _otherCategory = "";
		}
		catch (Exception ex)
		{
			_uploadProductMessage = $"Error uploading item: {ex.Message}";
		}
		finally
		{
			_isBusy = false;
		}
	}

	private bool IsValidPhotoUrl(string? url)
	{
		if (string.IsNullOrWhiteSpace(url)) return false;
		if (url.Length > 1024) return false;
		// Basic check; extend as needed.
		bool correctImageExtension = url.EndsWith(".jpg", StringComparison.OrdinalIgnoreCase)
			|| url.EndsWith(".jpeg", StringComparison.OrdinalIgnoreCase)
			|| url.EndsWith(".png", StringComparison.OrdinalIgnoreCase)
			|| url.EndsWith(".gif", StringComparison.OrdinalIgnoreCase)
			|| url.EndsWith(".bmp", StringComparison.OrdinalIgnoreCase)
			|| url.EndsWith(".webp", StringComparison.OrdinalIgnoreCase);

		return (url.StartsWith("http://", StringComparison.OrdinalIgnoreCase)
			|| url.StartsWith("https://", StringComparison.OrdinalIgnoreCase)
			) && correctImageExtension;

	}

	private bool IsFirstUrlFilled()
	{
		return !string.IsNullOrWhiteSpace(_photoUrl0) && IsValidPhotoUrl(_photoUrl0);
	}
}

<link href="css/Product.css" rel="stylesheet">

<div class="upload-page">
    <div class="upload-card">

  <h3 class="upload-title">Upload your new Item</h3>

@*Product upload inputs*@
<div class="mb-3">
	<label for="name" class="form-label">Item Name</label>
	<input type="text" class="form-control" id="name" @bind="_name" />
	@if (!_isStringValid(_name))
	{
		<div class="text-danger">Name cannot be empty.</div>
	}

	<label for="description" class="form-label">Description</label>
	<input type="text" class="form-control" id="description" @bind="_description" />
	@if (!_isStringValid(_description))
	{
		<div class="text-danger">Description cannot be empty.</div>
	}

	<label for="condition" class="form-label">Condition</label>
	<input type="text" class="form-control" id="condition" @bind="_condition" />
	@if (!_isStringValid(_condition))
	{
		<div class="text-danger">Condition cannot be empty.</div>
	}

	<label for="price" class="form-label">Price offer</label>
	<input type="number" class="form-control" id="price" @bind="_price" />
	@if (!_ispriceValid)
	{
		<div class="text-danger">Price must be non-negative.</div>
	}

	<label for="photoUrl" class="form-label">Photo URL (up to 5)</label>
	<input type="text" class="form-control" id="photoUrl" @bind="_photoUrl0" />
	@if (!IsFirstUrlFilled())
	{
		<div class="text-danger">Photo URL must be filled / URL is invalid</div>
	}
	@if (!string.IsNullOrWhiteSpace(_photoUrl0) && IsValidPhotoUrl(_photoUrl0))
	{
		<div class="mt-2">
			<strong>Preview:</strong><br />
			<div class="p-2 border rounded bg-light" style="max-width:600px">
				<img src="@_photoUrl0" alt="Image Preview" class="img-fluid"
					 style="max-height:300px ; object-fit:contain"
					 onerror="this.src='/images/placeholder.png';this.onerror=null;" />
			</div>
		</div>
	}
	<input type="text" class="form-control" id="photoUrl" @bind="_photoUrl1" />
	@if (!string.IsNullOrWhiteSpace(_photoUrl1) && !IsValidPhotoUrl(_photoUrl1))
	{
		<div class="text-danger">Photo URL is not valid.</div>
	}
	@if (!string.IsNullOrWhiteSpace(_photoUrl1) && IsValidPhotoUrl(_photoUrl1))
	{
		<div class="mt-2">
			<strong>Preview:</strong><br />
			<div class="p-2 border rounded bg-light" style="max-width:600px">
				<img src="@_photoUrl1" alt="Image Preview" class="img-fluid"
					 style="max-height:300px ; object-fit:contain"
					 onerror="this.src='/images/placeholder.png';this.onerror=null;" />
			</div>
		</div>
	}
	<input type="text" class="form-control" id="photoUrl" @bind="_photoUrl2" />
	@if (!string.IsNullOrWhiteSpace(_photoUrl2) && !IsValidPhotoUrl(_photoUrl2))
	{
		<div class="text-danger">Photo URL is not valid.</div>
	}
	@if (!string.IsNullOrWhiteSpace(_photoUrl2) && IsValidPhotoUrl(_photoUrl2))
	{
		<div class="mt-2">
			<strong>Preview:</strong><br />
			<div class="p-2 border rounded bg-light" style="max-width:600px">
				<img src="@_photoUrl2" alt="Image Preview" class="img-fluid"
					 style="max-height:300px ; object-fit:contain"
					 onerror="this.src='/images/placeholder.png';this.onerror=null;" />
			</div>
		</div>
	}
	<input type="text" class="form-control" id="photoUrl" @bind="_photoUrl3" />
	@if (!string.IsNullOrWhiteSpace(_photoUrl3) && !IsValidPhotoUrl(_photoUrl3))
	{
		<div class="text-danger">Photo URL is not valid.</div>
	}
	@if (!string.IsNullOrWhiteSpace(_photoUrl3) && IsValidPhotoUrl(_photoUrl3))
	{
		<div class="mt-2">
			<strong>Preview:</strong><br />
			<div class="p-2 border rounded bg-light" style="max-width:600px">
				<img src="@_photoUrl3" alt="Image Preview" class="img-fluid"
					 style="max-height:300px ; object-fit:contain"
					 onerror="this.src='/images/placeholder.png';this.onerror=null;" />
			</div>
		</div>
	}
	<input type="text" class="form-control" id="photoUrl" @bind="_photoUrl4" />
	@if (!string.IsNullOrWhiteSpace(_photoUrl4) && !IsValidPhotoUrl(_photoUrl4))
	{
		<div class="text-danger">Photo URL is not valid.</div>
	}
	@if (!string.IsNullOrWhiteSpace(_photoUrl4) && IsValidPhotoUrl(_photoUrl4))
	{
		<div class="mt-2">
			<strong>Preview:</strong><br />
			<div class="p-2 border rounded bg-light" style="max-width:600px">
				<img src="@_photoUrl4" alt="Image Preview" class="img-fluid"
					 style="max-height:300px ; object-fit:contain"
					 onerror="this.src='/images/placeholder.png';this.onerror=null;" />
			</div>
		</div>
	}


	<label for="category" class="form-label">Category</label>
	<select id="category" class="form-select" @bind="_category">
		@foreach (Category catagory in Enum.GetValues(typeof(Category)))
		{
			<option value="@catagory">@catagory</option>
		}
	</select>

	@if (_category == Category.OTHER)
	{
		<label for="otherCat" class="form-label mt-2">Category Name</label>
		<input type="text" class="form-control" @bind="_otherCategory" />
		@if (!_isStringValid(_otherCategory))
		{
			<div class="text-danger">Other Category cannot be empty.</div>
		}
	}

</div>

		 <button class="upload-btn" disabled="@_isBusy"
                @onclick="UploadNewProduct">
            @(_isBusy ? "uploading..." : "upload")
        </button>

        @if (!string.IsNullOrWhiteSpace(_uploadProductMessage))
        {
            <div class="mt-3">@_uploadProductMessage</div>
        }

    </div>
</div>
@page "/purchase"
@using ApiContracts
@attribute [Authorize(Roles = "Customer")]
@using ApiContracts.Dtos
@using System.Security.Claims
@using global::BlazorApp.Services.Interface
@rendermode InteractiveServer
@inject AuthenticationStateProvider AuthStateProvider

 @inject IPurchaseService PurchaseService
@inject ICartService CartService

<h3>Shopping Cart</h3>

@if (!CartService.Items.Any())
{
    <p>Your cart is empty.</p>
}
else
{


    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th style="width: 120px;">Price</th>
                <th style="width: 120px;">Quantity</th>
                <th style="width: 140px;">Subtotal</th>
                <th style="width: 80px;"></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in CartService.Items)
            {
                <tr>
                    <td>@item.Name</td>
                    <td>@item.Price DKK</td>
                    <td>
                        <input type="number"
                               class="form-control"
                               min="1"
                               value="@item.Quantity"
                               @onchange="e => ChangeQuantity(item.ProductId, e)" />
                    </td>
                    <td>@(item.Price * item.Quantity) DKK</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger"
                                @onclick="() => RemoveItem(item.ProductId)">
                            X
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <p><strong>Total: @CartService.TotalPrice DKK</strong></p>

    <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary" @onclick="Buy" disabled="@busy">
            @(busy ? "Buying..." : "Buy")
        </button>
        <button class="btn btn-outline-secondary" @onclick="ClearCart" disabled="@busy">
            Clear cart
        </button>
    </div>
}

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert @(success ? "alert-success" : "alert-danger") mt-3">
        @message
    </div>
}

@if (Result is not null)
{
    <hr />
    <h5>Raw result (debug)</h5>
    <pre>@System.Text.Json.JsonSerializer.Serialize(
            Result,
            new System.Text.Json.JsonSerializerOptions { WriteIndented = true })</pre>
}

@code {
    private int CustomerId { get; set; }

    private BuyProductsResultDto? Result;
    private string? message;
    private bool success;
    private bool busy;

    private void ChangeQuantity(int productId, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var quantity))
        {
            CartService.SetQuantity(productId, quantity);
        }
    }
    protected override async Task OnInitializedAsync()
{
    try
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var idClaim = user.FindFirst(ClaimTypes.NameIdentifier);
            if (idClaim != null && int.TryParse(idClaim.Value, out var id))
            {
                CustomerId = id;
            }
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"[Purchase] Error in OnInitializedAsync: {ex}");
    }
}


    private void RemoveItem(int productId)
    {
        CartService.RemoveItem(productId);
    }

    private void ClearCart()
    {
        CartService.Clear();
    }

    private async Task Buy()
    {
        busy = true;
        message = null;
        success = false;
        Result = null;

        if (!CartService.Items.Any())
        {
            message = "Your cart is empty.";
            busy = false;
            return;
        }

        if (CustomerId <= 0)
        {
            message = "Please enter a valid Customer Id.";
            busy = false;
            return;
        }

        Console.WriteLine($"[Purchase] BUY clicked C={CustomerId}, Items={CartService.Items.Count}");

        var dto = new BuyProductRequestDto
        {
            CustomerId = CustomerId,
            Items = CartService.Items
                .Select(i => new CartItemDto
                {
                    ProductId = i.ProductId,
                    Quantity = i.Quantity
                })
                .ToList()
        };

        try
        {
             Result = await PurchaseService.BuyProductsAsync(dto);

            success = true;
            message = $"Purchase completed. TransactionId = {Result.Transaction.Id}, " +
                      $"Total = {Result.ShoppingCart.TotalPrice}.";

            CartService.Clear();
        }
        catch (Exception ex)
        {
            success = false;
            message = $"Error: {ex.Message}";
            Console.WriteLine($"[Purchase] Error in Buy(): {ex}");
        }
        finally
        {
            busy = false;
        }
    }
}

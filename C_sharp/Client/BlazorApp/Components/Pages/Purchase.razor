@page "/purchase"
@using ApiContracts
@attribute [Authorize(Roles = "Customer")]
@using ApiContracts.Dtos
@using System.Security.Claims
@using global::BlazorApp.Services.Interface
@rendermode InteractiveServer
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

@inject IPurchaseService PurchaseService
@inject ICartService CartService

<link href="css/Product.css" rel="stylesheet">

<div class="container mt-4">

    @if (Result == null)
    {
        <div class="row g-4">

            <div class="col-md-7">
                <div class="card shadow-sm">
                    <div class="card-body">

                        <h4>Shopping Cart</h4>

                        @if (!CartService.Items.Any())
                        {
                            <p>Your cart is empty.</p>
                        }
                        else
                        {
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th style="width:120px;">Price</th>
                                        <th style="width:120px;">Quantity</th>
                                        <th style="width:140px;">Subtotal</th>
                                        <th style="width:80px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in CartService.Items)
                                    {
                                        <tr>
                                            <td>@item.Name</td>
                                            <td>@item.Price DKK</td>
                                            <td>
                                                <input type="number"
                                                       class="form-control"
                                                       min="1"
                                                       value="@item.Quantity"
                                                       @onchange="e => ChangeQuantity(item.ProductId, e)" />
                                            </td>
                                            <td>@(item.Price * item.Quantity) DKK</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-danger"
                                                        @onclick="() => RemoveItem(item.ProductId)">
                                                    X
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }

                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card shadow-sm">
                    <div class="card-body">

                        <h4>Credit Card Information</h4>

                        <EditForm Model="@creditCard" OnValidSubmit="Buy">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="mb-2">
                                <label>Card Number</label>
                                <InputText class="form-control" @bind-Value="creditCard.CardNumber" placeholder="0000 0000 0000 0000" />
                            </div>

                            <div class="mb-2">
                                <label>Cardholder Name</label>
                                <InputText class="form-control" @bind-Value="creditCard.CardholderName" />
                            </div>

                            <div class="row">
                                <div class="col-6 mb-2">
                                    <label>Expiration (MM/YY)</label>
                                    <InputText class="form-control" @bind-Value="creditCard.Expiration" placeholder="MM/YY" />
                                </div>
                                <div class="col-6 mb-2">
                                    <label>CVV</label>
                                    <InputText class="form-control" @bind-Value="creditCard.CVV" />
                                </div>
                            </div>

                            <div class="mt-3 d-flex gap-2">
                                <button class="btn btn-primary" type="submit" disabled="@busy">
                                    @(busy ? "Processing..." : "Pay Now")
                                </button>
                                <button class="btn btn-outline-secondary"
                                        type="button"
                                        @onclick="ClearCart"
                                        disabled="@busy">
                                    Clear cart
                                </button>
                            </div>
                        </EditForm>

                    </div>
                </div>

                @if (!string.IsNullOrEmpty(message) && !success)
                {
                    <div class="alert alert-danger mt-3">
                        @message
                    </div>
                }
            </div>

        </div>
    }
    else
    {
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow border-success">
                    <div class="card-header bg-success text-white text-center">
                        <h4 class="mb-0">Payment Successful!</h4>
                    </div>
                    <div class="card-body p-4">
                        
                        <div class="text-center mb-4">
                            <h2 class="text-success"><i class="bi bi-check-circle"></i></h2>
                            <h5>Thank you for your purchase</h5>
                            <p class="text-muted small">
                                Transaction ID: <strong>@Result.Transaction.Id</strong><br />
                                Date: @Result.Transaction.Date.ToLocalTime().ToString("f")
                            </p>
                        </div>

                        <hr />

                        <h5 class="mb-3">Order Summary</h5>
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-end">Unit Price</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var cartItem in Result.CartProducts)
                                {
                                    var productDetails = Result.PurchasedProduct.FirstOrDefault(p => p.Id == cartItem.ProductId);
                                    
                                    if(productDetails != null)
                                    {
                                        <tr>
                                            <td>
                                                <strong>@productDetails.Name</strong><br/>
                                                <small class="text-muted">@productDetails.Category</small>
                                            </td>
                                            <td class="text-center">@cartItem.Quantity</td>
                                            <td class="text-end">@productDetails.Price DKK</td>
                                            <td class="text-end">@(productDetails.Price * cartItem.Quantity) DKK</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                            <tfoot>
                                <tr class="fw-bold fs-5">
                                    <td colspan="3" class="text-end">Total Paid:</td>
                                    <td class="text-end text-success">@Result.ShoppingCart.TotalPrice DKK</td>
                                </tr>
                            </tfoot>
                        </table>

                        <div class="mt-4 text-center">
                            <button class="btn btn-primary btn-lg" @onclick="ResetPage">Continue Shopping</button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    }
</div>


@code {
    private int CustomerId { get; set; }

    private BuyProductsResultDto? Result;
    private string? message;
    private bool success;
    private bool busy;
    private CreditCardDto? creditCard = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var idClaim = user.FindFirst("CustomerId");
                if (idClaim != null && int.TryParse(idClaim.Value, out var id))
                {
                    CustomerId = id;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Purchase] Error in OnInitializedAsync: {ex}");
        }
    }

    private void ChangeQuantity(int productId, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var quantity))
        {
            CartService.SetQuantity(productId, quantity);
        }
    }

    private void RemoveItem(int productId)
    {
        CartService.RemoveItem(productId);
    }

    private void ClearCart()
    {
        CartService.Clear();
    }

    private void ResetPage()
    {
        // Resets the page state so the user can shop again
        Result = null;
        message = null;
        success = false;
        // Optionally navigate home:
        // NavigationManager.NavigateTo("/");
    }

    private async Task Buy()
    {
        busy = true;
        message = null;
        success = false;
        Result = null;
        creditCard ??= new CreditCardDto();

        if (!CartService.Items.Any())
        {
            message = "Your cart is empty.";
            busy = false;
            return;
        }
        if (!ValidateCreditCard(creditCard, out var validationError))
        {
            message = validationError;
            busy = false;
            return;
        }

        Console.WriteLine($"[Purchase] BUY clicked C={CustomerId}, Items={CartService.Items.Count}");

        var dto = new BuyProductRequestDto
        {
            CustomerId = CustomerId,
            Items = CartService.Items
                .Select(i => new CartItemDto
                {
                    ProductId = i.ProductId,
                    Quantity = i.Quantity
                })
                .ToList()
        };

        try
        {
            Result = await PurchaseService.BuyProductsAsync(dto);

            success = true;
            // We no longer need a text message since we are showing the Receipt UI
            // But we keep the boolean true for logic safety
            
            CartService.Clear();
            creditCard = new CreditCardDto();
        }
        catch (Exception ex)
        {
            success = false;
            message = $"Error: {ex.Message}";
            Console.WriteLine($"[Purchase] Error in Buy(): {ex}");
        }
        finally
        {
            busy = false;
        }
    }

    private bool ValidateCreditCard(CreditCardDto card, out string error)
    {
        error = null!;

        var digits = card.CardNumber?.Replace(" ", "");
        if (string.IsNullOrWhiteSpace(digits) || digits.Length != 16 || !digits.All(char.IsDigit))
        {
            error = "Card number must be 16 digits.";
            return false;
        }

        if (string.IsNullOrWhiteSpace(card.CardholderName))
        {
            error = "Cardholder name is required.";
            return false;
        }

        if (string.IsNullOrWhiteSpace(card.Expiration) || !System.Text.RegularExpressions.Regex.IsMatch(card.Expiration, @"^(0[1-9]|1[0-2])\/\d{2}$"))
        {
            error = "Expiration must be in MM/YY format.";
            return false;
        }

        if (string.IsNullOrWhiteSpace(card.CVV) || !(card.CVV.Length == 3 || card.CVV.Length == 4) || !card.CVV.All(char.IsDigit))
        {
            error = "CVV must be 3 or 4 digits.";
            return false;
        }

        return true;
    }
}

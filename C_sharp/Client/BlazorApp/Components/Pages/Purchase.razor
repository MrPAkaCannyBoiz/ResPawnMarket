@page "/purchase"
@using ApiContracts
@using ApiContracts.Dtos
@rendermode InteractiveServer
@inject BlazorApp.Services.Interface.IPurchaseService PurchaseService

<PageTitle>Purchase</PageTitle>

<h3>Purchase</h3>

<div class="row g-3">
    <div class="col-md-4">
        <label class="form-label">Customer Id</label>
        <input type="number" class="form-control" @bind="CustomerId" />
    </div>

    <div class="col-md-4">
        <label class="form-label">Product Id</label>
        <input type="number" class="form-control" @bind="ProductId" />
    </div>

    <div class="col-md-4">
        <label class="form-label">Quantity</label>
        <input type="number" class="form-control" @bind="Quantity" />
    </div>
</div>

<div class="mt-3 d-flex gap-2">
    <button class="btn btn-primary" @onclick="Buy" disabled="@busy">
        @(busy ? "Buying..." : "Buy")
    </button>
</div>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert @(success ? "alert-success" : "alert-danger") mt-3">
        @message
    </div>
}

@if (Result is not null)
{
    <hr />
    <h5>Raw result (debug)</h5>
    <pre>@System.Text.Json.JsonSerializer.Serialize(
        Result,
        new System.Text.Json.JsonSerializerOptions { WriteIndented = true })</pre>
}

@code {
    private int CustomerId { get; set; }
    private int ProductId  { get; set; }
    private int Quantity   { get; set; } = 1;

    private BuyProductsResultDto? Result;
    private string? message;
    private bool success;
    private bool busy;

    private async Task Buy()
    {
        busy = true;
        message = null;
        success = false;
        Result = null;

        // debug line – shows in browser dev tools console (F12 → Console)
        Console.WriteLine($"[Purchase] BUY clicked C={CustomerId}, P={ProductId}, Q={Quantity}");

        var dto = new BuyProductRequestDto
        {
            CustomerId = CustomerId,
            Items = new List<CartItemDto>
            {
                new CartItemDto
                {
                    ProductId = ProductId,
                    Quantity  = Quantity
                }
            }
        };

        try
        {
            Result = await PurchaseService.BuyProductsAsync(dto);

            success = true;
            message = $"Purchase completed. TransactionId = {Result.Transaction.Id}, " +
                      $"Total = {Result.ShoppingCart.TotalPrice}.";
        }
        catch (Exception ex)
        {
            success = false;

            // if you want short message:
            // message = $"Error: {ex.Message}";
            // if you want full stack trace (like your big error text):
            message = $"Error: {ex}";
        }
        finally
        {
            busy = false;
        }
    }
}
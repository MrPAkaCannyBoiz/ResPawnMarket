@page "/purchase"
@using ApiContracts
@attribute [Authorize(Roles = "Customer")]
@using ApiContracts.Dtos
@using System.Security.Claims
@using global::BlazorApp.Services.Interface
@rendermode InteractiveServer
@inject AuthenticationStateProvider AuthStateProvider

@inject IPurchaseService PurchaseService
@inject ICartService CartService

<h3>Shopping Cart</h3>

@if (!CartService.Items.Any())
{
    <p>Your cart is empty.</p>
    <p>debugging: your customer id from claim is: @CustomerId </p>
}
else
{
    <p>debugging: your customer id from claim is: @CustomerId </p>

    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th style="width: 120px;">Price</th>
                <th style="width: 120px;">Quantity</th>
                <th style="width: 140px;">Subtotal</th>
                <th style="width: 80px;"></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in CartService.Items)
            {
                <tr>
                    <td>@item.Name</td>
                    <td>@item.Price DKK</td>
                    <td>
                        <input type="number"
                               class="form-control"
                               min="1"
                               value="@item.Quantity"
                               @onchange="e => ChangeQuantity(item.ProductId, e)" />
                    </td>
                    <td>@(item.Price * item.Quantity) DKK</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger"
                                @onclick="() => RemoveItem(item.ProductId)">
                            X
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <p><strong>Total: @CartService.TotalPrice DKK</strong></p>




    <EditForm Model="@creditCard" OnValidSubmit="Buy">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <h5>Credit Card Information</h5>
        <div class="mb-2">
            <label>Card Number</label>
            <InputText class="form-control" @bind-Value="creditCard.CardNumber" maxlength="19" />
        </div>
        <div class="mb-2">
            <label>Cardholder Name</label>
            <InputText class="form-control" @bind-Value="creditCard.CardholderName" />
        </div>
        <div class="mb-2">
            <label>Expiration (MM/YY)</label>
            <InputText class="form-control" @bind-Value="creditCard.Expiration" maxlength="5" />
        </div>
        <div class="mb-2">
            <label>CVV</label>
            <InputText class="form-control" @bind-Value="creditCard.CVV" maxlength="4" />
        </div>

        <div class="mt-3 d-flex gap-2">
            <button class="btn btn-primary" type="submit" disabled="@busy">
                @(busy ? "Buying..." : "Buy")
            </button>
            <button class="btn btn-outline-secondary" type="button" @onclick="ClearCart" disabled="@busy">
                Clear cart
            </button>
        </div>
    </EditForm>
}

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert @(success ? "alert-success" : "alert-danger") mt-3">
        @message
    </div>
}

@if (Result is not null)
{
    <hr />
    <h5>Raw result (debug)</h5>
    <pre>@System.Text.Json.JsonSerializer.Serialize(
            Result,
            new System.Text.Json.JsonSerializerOptions { WriteIndented = true })</pre>
}

@code {
    private int CustomerId { get; set; }

    private BuyProductsResultDto? Result;
    private string? message;
    private bool success;
    private bool busy;
    private CreditCardDto? creditCard= new();

    private void ChangeQuantity(int productId, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var quantity))
        {
            CartService.SetQuantity(productId, quantity);
        }
    }
    protected override async Task OnInitializedAsync()
{
    try
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var idClaim = user.FindFirst("CustomerId");
            if (idClaim != null && int.TryParse(idClaim.Value, out var id))
            {
                CustomerId = id;
            }
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"[Purchase] Error in OnInitializedAsync: {ex}");
    }
}


    private void RemoveItem(int productId)
    {
        CartService.RemoveItem(productId);
    }

    private void ClearCart()
    {
        CartService.Clear();
    }

    private async Task Buy()
    {
        busy = true;
        message = null;
        success = false;
        Result = null;
		creditCard ??= new CreditCardDto();
        if (!CartService.Items.Any())
        {
            message = "Your cart is empty.";
            busy = false;
            return;
        }
        if (!ValidateCreditCard(creditCard, out var validationError))
        {
            message = validationError;
            busy = false;
            return;
        }

        Console.WriteLine($"[Purchase] BUY clicked C={CustomerId}, Items={CartService.Items.Count}");

        var dto = new BuyProductRequestDto
        {
            CustomerId = CustomerId,
            Items = CartService.Items
                .Select(i => new CartItemDto
                {
                    ProductId = i.ProductId,
                    Quantity = i.Quantity
                })
                .ToList()
        };

        try
        {
             Result = await PurchaseService.BuyProductsAsync(dto);

            success = true;
            message = $"Purchase completed. TransactionId = {Result.Transaction.Id}, " +
                      $"Total = {Result.ShoppingCart.TotalPrice}.";

       
            CartService.Clear();
            creditCard = new CreditCardDto();
        }
        catch (Exception ex)
        {
            success = false;
            message = $"Error: {ex.Message}";
            Console.WriteLine($"[Purchase] Error in Buy(): {ex}");
        }
        finally
        {
            busy = false;
        }
    }


    private bool ValidateCreditCard(CreditCardDto card, out string error)
    {
        error = null!;

       
        var digits = card.CardNumber?.Replace(" ", "");
        if (string.IsNullOrWhiteSpace(digits) || digits.Length != 16 || !digits.All(char.IsDigit))
        {
            error = "Card number must be 16 digits.";
            return false;
        }

       
        if (string.IsNullOrWhiteSpace(card.CardholderName))
        {
            error = "Cardholder name is required.";
            return false;
        }

        
        if (string.IsNullOrWhiteSpace(card.Expiration) || !System.Text.RegularExpressions.Regex.IsMatch(card.Expiration, @"^(0[1-9]|1[0-2])\/\d{2}$"))
        {
            error = "Expiration must be in MM/YY format.";
            return false;
        }

        
        if (string.IsNullOrWhiteSpace(card.CVV) || !(card.CVV.Length == 3 || card.CVV.Length == 4) || !card.CVV.All(char.IsDigit))
        {
            error = "CVV must be 3 or 4 digits.";
            return false;
        }

        return true;
    }
}
